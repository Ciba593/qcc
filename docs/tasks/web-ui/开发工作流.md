# QCC Web UI - 开发工作流指南

## 🎯 概述

本文档详细说明如何在开发环境中进行 QCC Web UI 的前后端开发，包括热重载配置、调试技巧和常见问题解决。

---

## 🔥 热重载开发模式

### 推荐工作流：前后端同时热重载

这是最高效的开发方式，前后端代码修改都能立即生效，无需手动重启。

#### 步骤 1: 启动后端开发服务器

**打开终端 1**，在项目根目录执行：

```bash
# 方式 1: 使用 uvx (推荐，无需安装)
uvx --from . qcc web start --dev --no-browser

# 方式 2: 如果已安装 qcc
qcc web start --dev --no-browser

# 方式 3: 直接使用 uvicorn
uvicorn fastcc.web.app:app --reload --host 127.0.0.1 --port 8080
```

**后端服务信息**:
- **监听地址**: http://127.0.0.1:8080
- **API 文档**: http://127.0.0.1:8080/api/docs
- **热重载**: ✅ 自动监听 `fastcc/web/` 目录下所有 `.py` 文件
- **日志级别**: DEBUG (显示详细请求信息)

**热重载触发条件**:
- 修改 `fastcc/web/` 下的任何 Python 文件
- 修改路由文件 (`routers/*.py`)
- 修改模型文件 (`models.py`)
- 修改工具函数 (`utils.py`)

#### 步骤 2: 启动前端开发服务器

**打开终端 2**，在项目根目录执行：

```bash
# 进入前端目录
cd qcc-web

# 首次运行需要安装依赖
npm install

# 启动 Vite 开发服务器
npm run dev
```

**前端服务信息**:
- **监听地址**: http://localhost:5173
- **API 代理**: 自动代理 `/api/*` 到 http://127.0.0.1:8080
- **热模块替换 (HMR)**: ✅ 浏览器无刷新更新
- **快速刷新**: ✅ React 组件状态保持

**热重载触发条件**:
- 修改 `src/` 下的任何 `.tsx`、`.ts`、`.jsx`、`.js` 文件
- 修改 `src/` 下的 CSS 文件
- 修改 `index.html`

#### 步骤 3: 开始开发

1. **浏览器访问**: http://localhost:5173
2. **开发工具**: 打开浏览器开发者工具 (F12)
3. **修改代码**:
   - 编辑前端代码 → 浏览器自动刷新
   - 编辑后端代码 → 服务器自动重启
4. **查看日志**:
   - 前端日志在终端 2 和浏览器控制台
   - 后端日志在终端 1

---

## 🛠️ 开发场景与工作流

### 场景 1: 仅开发前端 UI

**适用于**: 修改样式、组件、页面布局，不涉及 API 变更

```bash
# 终端 1: 启动后端（生产模式）
qcc web start --no-browser

# 终端 2: 启动前端开发服务器
cd qcc-web && npm run dev

# 访问: http://localhost:5173
```

**优点**:
- 前端热重载快速
- 后端稳定运行
- API 响应速度快

### 场景 2: 仅开发后端 API

**适用于**: 添加新 API、修改业务逻辑，不涉及前端变更

```bash
# 确保前端已构建
cd qcc-web && npm run build
cp -r dist/* ../fastcc/web/static/

# 启动后端开发服务器
cd .. && qcc web start --dev

# 访问: http://127.0.0.1:8080
# API 文档: http://127.0.0.1:8080/api/docs
```

**优点**:
- 后端热重载
- 使用 Swagger UI 测试 API
- 无需前端编译等待

### 场景 3: 全栈开发

**适用于**: 同时开发前后端功能

```bash
# 终端 1: 后端热重载
uvx --from . qcc web start --dev --no-browser

# 终端 2: 前端热重载
cd qcc-web && npm run dev

# 访问: http://localhost:5173
```

**优点**:
- 前后端代码修改立即生效
- 完整的开发体验
- 最高效的迭代速度

---

## 🔍 调试技巧

### 后端调试

#### 1. 使用 print/日志调试

```python
# fastcc/web/routers/dashboard.py
@router.get("/summary")
async def get_dashboard_summary():
    print(f"[DEBUG] 开始获取仪表盘数据")  # 会显示在终端 1

    config_manager = ConfigManager()
    profiles = to_dict_list(config_manager.list_profiles())

    print(f"[DEBUG] 找到 {len(profiles)} 个配置")

    return ApiResponse(success=True, data={"profiles": profiles})
```

#### 2. 使用 Python 调试器

```bash
# 在代码中添加断点
import pdb; pdb.set_trace()

# 或使用 ipdb (更友好)
import ipdb; ipdb.set_trace()
```

#### 3. 查看详细错误

修改 `fastcc/web/app.py` 添加详细错误处理：

```python
import traceback

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    error_detail = f"{str(exc)}\n\nTraceback:\n{traceback.format_exc()}"
    return JSONResponse(
        status_code=500,
        content={"detail": error_detail}
    )
```

#### 4. 使用 Swagger UI 测试

访问 http://127.0.0.1:8080/api/docs 可以：
- 查看所有 API 端点
- 直接测试 API 调用
- 查看请求/响应格式

### 前端调试

#### 1. React DevTools

安装浏览器扩展：
- [React Developer Tools](https://react.dev/learn/react-developer-tools)

功能：
- 查看组件树
- 检查 Props 和 State
- 性能分析

#### 2. React Query DevTools

已集成在开发环境，查看：
- 所有 Query 状态
- 缓存数据
- 请求时间线

```typescript
// src/App.tsx 中已启用
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

<QueryClientProvider client={queryClient}>
  <App />
  <ReactQueryDevtools initialIsOpen={false} />
</QueryClientProvider>
```

#### 3. 网络请求调试

打开浏览器开发者工具 → Network 标签：
- 查看所有 API 请求
- 检查请求/响应数据
- 查看请求耗时

#### 4. 控制台日志

```typescript
// src/pages/Dashboard.tsx
export default function Dashboard() {
  const { data, isLoading, error } = useQuery({
    queryKey: ['dashboard-summary'],
    queryFn: async () => {
      console.log('[DEBUG] 开始请求仪表盘数据');
      const response = await api.dashboard.getSummary();
      console.log('[DEBUG] 仪表盘数据:', response.data);
      return response;
    }
  });
}
```

---

## 📦 构建与部署

### 前端构建

```bash
cd qcc-web

# 开发构建（含 source map）
npm run build

# 生产构建（优化、压缩）
npm run build -- --mode production

# 预览构建结果
npm run preview
```

### 部署到后端

```bash
# 方式 1: 手动复制
cd qcc-web
npm run build
cp -r dist/* ../fastcc/web/static/

# 方式 2: 使用脚本
./scripts/deploy-web.sh  # 如果有部署脚本
```

### 测试生产构建

```bash
# 启动生产模式服务器
qcc web start

# 访问 http://127.0.0.1:8080
# 测试所有功能是否正常
```

---

## ⚠️ 常见问题

### 问题 1: 后端修改后未生效

**症状**: 修改了 Python 代码，但 API 响应没有变化

**解决**:
1. 检查是否使用了 `--dev` 参数
2. 查看终端是否显示 "Reloading..."
3. 确保修改的文件在 `fastcc/web/` 目录下
4. 尝试手动重启服务器

### 问题 2: 前端修改后未刷新

**症状**: 修改了 React 组件，浏览器没有更新

**解决**:
1. 检查终端是否有编译错误
2. 手动刷新浏览器 (Ctrl+R 或 Cmd+R)
3. 清除浏览器缓存 (Ctrl+Shift+R 或 Cmd+Shift+R)
4. 检查 Vite 开发服务器是否正常运行

### 问题 3: API 请求失败 (CORS)

**症状**: 前端请求后端 API 时出现跨域错误

**解决**:
1. 确保后端启动在 http://127.0.0.1:8080
2. 检查前端 `src/api/client.ts` 中的 `baseURL`
3. 确认后端 CORS 配置正确 (`fastcc/web/app.py`)

### 问题 4: 端口占用

**症状**: 启动服务时提示端口已被占用

**解决**:
```bash
# 查找占用端口的进程
lsof -i :8080   # macOS/Linux
netstat -ano | findstr :8080  # Windows

# 杀死进程
kill -9 <PID>   # macOS/Linux
taskkill /PID <PID> /F  # Windows

# 或使用其他端口
qcc web start --port 3000
```

### 问题 5: npm install 失败

**症状**: 安装前端依赖时出错

**解决**:
```bash
# 清除缓存重新安装
cd qcc-web
rm -rf node_modules package-lock.json
npm cache clean --force
npm install

# 或使用国内镜像
npm install --registry=https://registry.npmmirror.com
```

---

## 🚀 性能优化建议

### 后端优化

1. **使用异步操作**:
```python
# 好的做法
async def get_data():
    result = await async_operation()
    return result

# 避免阻塞
def sync_operation():
    time.sleep(5)  # 会阻塞整个服务器
```

2. **添加缓存**:
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def expensive_operation():
    # 缓存计算结果
    pass
```

3. **批量数据库查询**:
```python
# 避免 N+1 查询
configs = config_manager.list_profiles()  # 一次查询所有
```

### 前端优化

1. **使用 React Query 缓存**:
```typescript
const { data } = useQuery({
  queryKey: ['configs'],
  queryFn: api.configs.list,
  staleTime: 5000,  // 5秒内不重新请求
  cacheTime: 300000,  // 缓存 5 分钟
});
```

2. **懒加载页面**:
```typescript
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Configs = lazy(() => import('./pages/Configs'));
```

3. **避免不必要的重新渲染**:
```typescript
import { memo } from 'react';

const ConfigCard = memo(({ config }) => {
  return <Card>...</Card>;
});
```

---

## 📚 相关文档

- **[快速开始](./快速开始.md)** - 安装和启动指南
- **[开发计划](./开发计划.md)** - 完整的开发计划
- **[开发完成报告](./开发完成报告.md)** - Phase 1 完成情况
- **[API 文档](http://127.0.0.1:8080/api/docs)** - 后端 API 参考

---

## 💡 开发提示

1. **保持服务器运行**: 开发时让前后端服务器保持运行，修改代码会自动生效
2. **使用 Git 分支**: 为每个新功能创建独立分支
3. **频繁测试**: 每次修改后在浏览器中验证功能
4. **查看日志**: 遇到问题先查看终端和浏览器控制台的日志
5. **利用工具**: 充分使用 React DevTools、Swagger UI 等开发工具

---

*最后更新: 2025-10-17*
*版本: v1.0.0*
